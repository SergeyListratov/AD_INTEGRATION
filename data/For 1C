//HTTP на стороне 1С.  Авторизация, получение токена, работа с пользователями.


&НаСервере

Процедура ПройтиАвторизациюНаСервере()

               Сообщение = Новый СообщениеПользователю;

                Если НЕ ЗначениеЗаполнено(Пользователь) ИЛИ НЕ ЗначениеЗаполнено(Пароль) Тогда

                               Сообщение.Текст = "Для авторизации необходимо указать ""Имя пользователя"" и ""Пароль""!";

                               Сообщение.Сообщить();

                               Возврат;

                КонецЕсли;



                Соединение = ПолучитьСоединение();



                АдресРесурса = "/auth/login";

                Заголовки = Новый Соответствие;

                Заголовки.Вставить("Content-Type", "application/json");



                HTTPЗапрос = Новый HTTPЗапрос(АдресРесурса, Заголовки);

                МассивJSON = Новый Массив;

                СтруктураЛогин = Новый Структура;

                СтруктураЛогин.Вставить("login", Пользователь);

                СтруктураЛогин.Вставить("password", Пароль);



                ЗаписьJSON = Новый ЗаписьJSON();

                ЗаписьJSON.УстановитьСтроку();

                ЗаписатьJSON(ЗаписьJSON, СтруктураЛогин);

                СериализованнаяСтрока = ЗаписьJSON.Закрыть();

                HTTPЗапрос.УстановитьТелоИзСтроки(СериализованнаяСтрока);

                ТокенДоступа = "";

                Попытка

                               Результат = Соединение.ОтправитьДляОбработки(HTTPЗапрос);

                               Если Результат.КодСостояния = 200 Тогда

                                               ТокенДоступа = Результат.ПолучитьТелоКакСтроку();

                                               Для Каждого Заг ИЗ Результат.Заголовки Цикл

                                                               Если Заг.Ключ = "set-cookie" Тогда

                                                                              Куки = Заг.Значение;

                                                                              //ДлинаСтр = СтрНайти(Куки,";");

                                                                              //Куки = Лев(Куки,ДлинаСтр-1);

                                                                              //Куки = СтрЗаменить(Куки,"ad_access_token=","");

                                                               КонецЕсли;

                                               КонецЦикла;

                                               Сообщение.Текст = "Авторизация пройдена успешно";

                                               АвторизацияПройдена = Истина;

                               Иначе

                                               Сообщение.Текст = "Авторизация не пройдена по причине - " + Результат.ПолучитьТелоКакСтроку();

                               КонецЕсли;

                               Сообщение.Сообщить();

                Исключение

                               Сообщение.Текст = ОписаниеОшибки();

                               Сообщение.Сообщить();

                               Возврат;

                КонецПопытки;

КонецПроцедуры



&НаКлиенте

Процедура Авторизация(Команда)

                ПройтиАвторизациюНаСервере();

КонецПроцедуры



&НаСервере

Процедура ОтключитьсяНаСервере()

                Если ЗначениеЗаполнено(Куки) Тогда

                               Соединение = ПолучитьСоединение();

                               Сообщение = Новый СообщениеПользователю;

                               ТокенДоступа = Куки;

                               АдресРесурса = "/auth/logout";

                               Заголовки = Новый Соответствие;

                               Заголовки.Вставить("Content-Type", "application/json");

                               Заголовки.Вставить("set-cookie", ТокенДоступа);

                               HTTPЗапрос = Новый HTTPЗапрос(АдресРесурса, Заголовки);

                               Попытка  //отправляем данные

                                               //Результат = Соединение.Получить(HTTPЗапрос);

                                               Результат = Соединение.ОтправитьДляОбработки(HTTPЗапрос);

                                               Сообщить(Результат.ПолучитьТелоКакСтроку());

                                               Если Результат.КодСостояния = 200 Тогда

                                                               АвторизацияПройдена = Ложь;

                                                               Куки = "";

                                               КонецЕсли;

                               Исключение

                                               Сообщение.Текст = ОписаниеОшибки();

                                               Сообщение.Сообщить();

                                               Возврат;

                               КонецПопытки;

                КонецЕсли;

КонецПроцедуры



&НаСервере

Функция ПолучитьСоединение()

                Соединение = Новый HTTPСоединение(

                "IP adress server" // Имя сервера (хост), иногда указывается внутри домена как SRV.test

                ,port);     // порт, по умолчанию для http используется 80, для https 443);

                Возврат Соединение;

КонецФункции



&НаКлиенте

Процедура Отключиться(Команда)

                ОтключитьсяНаСервере();

КонецПроцедуры



&НаСервере

Процедура ОбработатьПользователейНаСервере()

                Для Каждого СтрПользователя ИЗ Объект.Пользователи Цикл

                               Если СтрПользователя.Обработать Тогда

                                               СоздатьОбновитьПользователяВАД(СтрПользователя);

                               КонецЕсли;

                КонецЦикла;

КонецПроцедуры



&НаСервере

Процедура СоздатьОбновитьПользователяВАД(СтрПользователя)

                Если ЗначениеЗаполнено(Куки) Тогда

                               Соединение = ПолучитьСоединение();

                               Сообщение = Новый СообщениеПользователю;

                               ТокенДоступа = Куки;

                               АдресРесурса = "/ad_user/integration";

                               Заголовки = Новый Соответствие;

                               Заголовки.Вставить("Content-Type", "application/json");

                               Заголовки.Вставить("Cookie", ТокенДоступа);

                               HTTPЗапрос = Новый HTTPЗапрос(АдресРесурса, Заголовки);

                               СтруктураНовыйПользователь = Новый Структура;

                               СтруктураНовыйПользователь.Вставить("first_name", СтрПользователя.first_name);

                               СтруктураНовыйПользователь.Вставить("other_name", СтрПользователя.other_name);

                               СтруктураНовыйПользователь.Вставить("last_name", СтрПользователя.last_name);

                               СтруктураНовыйПользователь.Вставить("number", СтрПользователя.number);

                               СтруктураНовыйПользователь.Вставить("division", СтрПользователя.division);

                               СтруктураНовыйПользователь.Вставить("role", СтрПользователя.role);

                               СтруктураНовыйПользователь.Вставить("action", СтрПользователя.action);



                               СтруктураОтвет = Новый Структура;

                               СтруктураОтвет.Вставить("status", "");

                               СтруктураОтвет.Вставить("message", "");

                               СтруктураОтвет.Вставить("email", "");



                               СтруктураМассивПользователь = Новый Структура;

                               СтруктураМассивПользователь.Вставить("ad_user", СтруктураНовыйПользователь);

                               СтруктураМассивПользователь.Вставить("response_model", СтруктураОтвет);



                               ЗаписьJSON = Новый ЗаписьJSON();

                               ЗаписьJSON.УстановитьСтроку();

                               ЗаписатьJSON(ЗаписьJSON, СтруктураМассивПользователь);

                               СериализованнаяСтрока = ЗаписьJSON.Закрыть();

                               HTTPЗапрос.УстановитьТелоИзСтроки(СериализованнаяСтрока);



                               Попытка  //отправляем данные

                                               //Результат = Соединение.Получить(HTTPЗапрос);

                                               Результат = Соединение.ОтправитьДляОбработки(HTTPЗапрос);

                                               Сообщить(Результат.ПолучитьТелоКакСтроку());

                               Исключение

                                               Сообщение.Текст = ОписаниеОшибки();

                                               Сообщение.Сообщить();

                                               Возврат;

                               КонецПопытки;

                КонецЕсли;



КонецПроцедуры



&НаКлиенте

Процедура ОбработатьПользователей(Команда)

                ОбработатьПользователейНаСервере();

КонецПроцедуры



Функция СформироватьСписокДействий()

               СписокВыбораДействия = Новый СписокЗначений;

                СписокВыбораДействия.Добавить("create");

                СписокВыбораДействия.Добавить("transfer");

                СписокВыбораДействия.Добавить("dismiss");

КонецФункции